<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Game</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
    height: 100%;
    background: #05bd8c;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: monospace;
}

/* WRAPPER */
#wrapper {
    width: 100%;
    max-width: 100%;
    height: calc(var(--vh) * 85);
    background: #bfeab3;
    border: 4px solid #121510;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* SCOREBAR */
#scorebar {
    height: calc(var(--vh) * 6);
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:min(5vw,28px);
    font-weight:bold;
    background:#7ef354;
    color:#000;
}

/* LINE */
#divider {
    width:100%;
    height: calc(var(--vh) * 0.5);
    background:#10120f;
}

/* GAME CANVAS */
#gameCanvas {
    width:100%;
    height: calc(var(--vh) * 48);
    background:#e5f2e0;
    border-bottom:3px solid #0a0c08;
    image-rendering: pixelated;
}

/* CONTROL CANVAS */
#ctrlCanvas {
    width:100%;
    height: calc(var(--vh) * 25);
    background:#405138;
}
</style>
</head>

<body>

<!-- FIX VH (HANDY ORIENTIERUNG BUG) -->
<script>
function fixVH() {
    document.documentElement.style.setProperty(
        "--vh",
        window.innerHeight * 0.01 + "px"
    );
}
fixVH();
window.addEventListener("resize", fixVH);
</script>

<div id="wrapper">
    <div id="scorebar">Score: 0 | Run: 0 | Highscore: 0</div>
    <div id="divider"></div>

    <canvas id="gameCanvas"></canvas>
    <canvas id="ctrlCanvas"></canvas>
</div>

<script>
/* ----------- GAME CANVAS ----------- */
const gameCanvas = document.getElementById("gameCanvas");
const g = gameCanvas.getContext("2d");

function resizeGame() {
    gameCanvas.width = gameCanvas.clientWidth;
    gameCanvas.height = gameCanvas.clientHeight;
}
resizeGame();
window.addEventListener("resize", () => { resizeGame(); resizeCtrl(); });

let tileCount = 20;
let snakeX = 10, snakeY = 10;
let velocityX = 0, velocityY = 0;
let snake = [];
let snakeLength = 3;

let foodX = 5, foodY = 5;

let runScore = 0;  // Score während laufendem Spiel
let totalScore = 0; // Summe aller Punkte über mehrere Spiele
let highscore = Number(localStorage.getItem("snakeHighscore")) || 0;

function updateScorebar() {
    document.getElementById("scorebar").textContent =
    `Score: ${totalScore} | Run: ${runScore} | Highscore: ${highscore}`;
}
updateScorebar();

let speed = 7;

/* GAME LOOP */
function gameLoop() {
    setTimeout(() => {
        requestAnimationFrame(gameLoop);
        update();
        draw();
    }, 1000/speed);
}
gameLoop();

/* UPDATE */
function update() {
    snakeX += velocityX;
    snakeY += velocityY;

    if (snakeX < 0) snakeX = tileCount - 1;
    if (snakeX >= tileCount) snakeX = 0;
    if (snakeY < 0) snakeY = tileCount - 1;
    if (snakeY >= tileCount) snakeY = 0;

    snake.push({ x: snakeX, y: snakeY });
    while (snake.length > snakeLength) snake.shift();

    for (let i=0;i<snake.length-1;i++)
        if(snake[i].x===snakeX && snake[i].y===snakeY)
            resetGame();

    if (snakeX === foodX && snakeY === foodY) {
        snakeLength++;
        runScore++;
        totalScore++;

        if (totalScore > highscore) {
            highscore = totalScore;
            localStorage.setItem("snakeHighscore", highscore);
        }

        updateScorebar();

        foodX = Math.floor(Math.random() * tileCount);
        foodY = Math.floor(Math.random() * tileCount);
    }
}

/* DRAW */
function draw() {
    const tileSize = Math.min(
        gameCanvas.clientWidth / tileCount,
        gameCanvas.clientHeight / tileCount
    );

    const gap = tileSize * 0.12;
    const size = tileSize - gap * 2;
    const radius = size * 0.15;

    g.fillStyle = "#c6ffb3";
    g.fillRect(0,0,gameCanvas.width,gameCanvas.height);

    // Snake
    g.fillStyle = "#2e2e2e";
    snake.forEach(p => {
        g.beginPath();
        g.roundRect(
            p.x * tileSize + gap,
            p.y * tileSize + gap,
            size,
            size,
            radius
        );
        g.fill();
    });

    // Food
    const foodSize = size * 0.7;
    const foodRadius = foodSize * 0.15;
    const offset = (tileSize - foodSize) / 2;

    g.beginPath();
    g.roundRect(
        foodX * tileSize + offset,
        foodY * tileSize + offset,
        foodSize,
        foodSize,
        foodRadius
    );
    g.fill();
}

/* RESET */
function resetGame() {
    snakeX=10; snakeY=10;
    velocityX=0; velocityY=0;
    snake=[];
    snakeLength=3;

    runScore = 0;  // aktueller Run zurücksetzen
    updateScorebar();
}

/* ----------- CONTROLS ----------- */
const ctrlCanvas = document.getElementById("ctrlCanvas");
const c = ctrlCanvas.getContext("2d");

function resizeCtrl() {
    ctrlCanvas.width = ctrlCanvas.clientWidth;
    ctrlCanvas.height = ctrlCanvas.clientHeight;
    drawControls();
}
resizeCtrl();

function drawArrow(x,y,size,angle){
    c.save();
    c.translate(x,y);
    c.rotate(angle);

    c.lineWidth=size*0.22;
    c.lineJoin="round";
    c.strokeStyle="#000";

    c.beginPath();
    c.moveTo(0,-size);
    c.lineTo(-size*0.55,size*0.35);
    c.lineTo(0,-size*0.1);
    c.lineTo(size*0.55,size*0.35);
    c.closePath();
    c.stroke();

    c.restore();
}

function drawControls(){
    c.fillStyle="#c6ffb3";
    c.fillRect(0,0,ctrlCanvas.width,ctrlCanvas.height);

    let cx=ctrlCanvas.width/2;
    let cy=ctrlCanvas.height/2;

    let size=ctrlCanvas.height*0.18;

    drawArrow(cx, cy-size*1.3, size, 0);
    drawArrow(cx, cy+size*1.3, size, Math.PI);
    drawArrow(cx-size*1.9, cy, size, -Math.PI/2);
    drawArrow(cx+size*1.9, cy, size, Math.PI/2);
}

/* TOUCH CONTROL */
ctrlCanvas.addEventListener("touchstart", e=>{
    let r=ctrlCanvas.getBoundingClientRect();
    let x=e.touches[0].clientX-r.left;
    let y=e.touches[0].clientY-r.top;

    let cx=ctrlCanvas.width/2;
    let cy=ctrlCanvas.height/2;

    if(y<cy-ctrlCanvas.height*0.18 && velocityY!==1)
        velocityX=0,velocityY=-1;
    else if(y>cy+ctrlCanvas.height*0.18 && velocityY!==-1)
        velocityX=0,velocityY=1;
    else if(x<cx-ctrlCanvas.width*0.18 && velocityX!==1)
        velocityX=-1,velocityY=0;
    else if(x>cx+ctrlCanvas.width*0.18 && velocityX!==-1)
        velocityX=1,velocityY=0;
});

/* KEYBOARD */
document.addEventListener("keydown",e=>{
    if(e.key==="ArrowUp"&&velocityY!==1)velocityX=0,velocityY=-1;
    if(e.key==="ArrowDown"&&velocityY!==-1)velocityX=0,velocityY=1;
    if(e.key==="ArrowLeft"&&velocityX!==1)velocityX=-1,velocityY=0;
    if(e.key==="ArrowRight"&&velocityX!==-1)velocityX=1,velocityY=0;
});
</script>

</body>
</html>
